# tcp可靠机制_2

### **连接管理**

>1. **三次握手**
>
>![image](https://github.com/Lp700750/Blogs/assets/104414865/7a5e7843-356c-4d75-afb6-ff26cc75bd49)
>
>- **为什么是三次握手？**
>
>1. 握手的目的是两台主机之间进行通信，3次握手是双方之间进行连接的最少次数。
>2. TCP协议是一种全双工的协议，因此两个主机之间必须要满足收发数据正常，第一第二次握手，可以保证主机A是满足条件的，但是第一第二次握手却只能够满足主机B是收正常的，但是不能够保证主机B是发正常的，只有当主机A发送第三次ACK被主机B收到之后，才能够说明主机B是发数据正常。
>
>- 1，2，4，5....握手为什么不行
>
>1. 1，2握手不满住主机A和主机B之间是否是正常的连接和全双工的通信协议，另外TCP协议的三次握手是最大概率的连接成功，是不能够保证100%连接成功的，因为第三次ACK可能会丢失。因此4，5次握手不是不可以，只是三次就能够成功多了话就会浪费两台主机之间的连接成本。
>2. 这里主机A在进行完第二次握手之后，主机A就会认为连接就建立成功，但是有一定的时间间隔之后如果主机B收到主机A发送过来的ACK之后，主机B 才算建立连接是成功的
>
>1. **四次挥手**
>
>![image](https://github.com/Lp700750/Blogs/assets/104414865/4c123ce0-dad0-4b0b-afb5-2161d4a2991c)
>
>1. **为什么是四次挥手？**
>
>因为断开连接是主机A和主机B双方的事情，一方想要断开连接需要给对方发送FIN，对方同意之后发送ACK，对方也需要给你发送FIN，当你同意之后也发送ACK，经过这四个步骤之后，通信双方才能够说明真正的断开了连接，因此需要至少四次挥手才行。
>
>1. TCP协议规定，主动断开连接的一方处于TIME_WAIT状态，等待两个MSL(报文最大生存时间)，才能回到CLOSED状态。为什么等待两个MSL？
>
>- 保证两个传输方向上阻塞再网络里的报文都已经消散。
>- 保证了最后一个ACK的到达，如果最后一个ACK丢失，服务器重发FIN，客户端等待两个MSL，可以收到重发的FIN。再丢失ACK的概率很小。
>
>1.  四次挥手CLOSE_WAIT状态
>
>-  连接由CLOSE_WAIT状态变为LAST_ACK状态，需要应用层调用close关闭套接字， 如果进程一直处于CLOSE_WAIT状态，说明在应用层的程序中有BUG，没有关闭关闭套接字。

